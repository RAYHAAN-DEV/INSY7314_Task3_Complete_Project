version: 2.1

orbs:
  node: circleci/node@5.1.0

# Re-usable executor for Node 20
executors:
  node20:
    docker:
      - image: cimg/node:20.18

jobs:
  # (Optional) quick build to prove both frontends build
  build_frontends:
    executor: node20
    steps:
      - checkout
      - node/install-packages:
          app-dir: frontend
          pkg-manager: npm
      - run:
          name: Build customer frontend
          working_directory: frontend
          command: |
            npm run build || echo "No build script - skipping"
      - node/install-packages:
          app-dir: employee-frontend
          pkg-manager: npm
      - run:
          name: Build employee frontend
          working_directory: employee-frontend
          command: |
            npm run build || echo "No build script - skipping"

  # SonarCloud analysis (no download needed; uses official image)
  sonar_scan:
    docker:
      - image: sonarsource/sonar-scanner-cli:5.0.1
    environment:
      SONAR_HOST_URL: "https://sonarcloud.io"
    steps:
      - checkout
      - run:
          name: Run SonarCloud analysis (backend + frontends)
          command: |
            sonar-scanner \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.organization="${SONAR_ORG}" \
              -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.sources=backend,frontend,employee-frontend \
              -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.vite/**

workflows:
  build_and_analyze:
    jobs:
      - build_frontends
      - sonar_scan:
          requires:
            - build_frontends
